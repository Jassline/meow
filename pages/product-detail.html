<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å•†å“è©³æƒ… | MEOW SELECT</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <nav>
        <a href="../index.html" class="logo">MEOW SELECT</a>
        <div class="nav-links">
            <a href="../index.html">é¦–é </a>
            <a href="about.html">å“ç‰Œæ•…äº‹</a>
            <a href="shop.html" style="color:#ff9f43; font-weight:bold;">æ‰€æœ‰å•†å“</a>
            <a href="member.html">æœƒå“¡ä¸­å¿ƒ</a>
            <button id="cart-btn">ğŸ›’ è³¼ç‰©è»Š</button>
        </div>
    </nav>

    <div class="overlay"></div>

    <div class="product-main-container">
        <a href="javascript:history.back()" class="back-btn">â† è¿”å›ä¸Šä¸€é </a>

        <div class="product-detail-flex">
            <img src="" id="p-img" class="product-img">

            <div class="product-info-box">
                <h1 id="p-name">è¼‰å…¥ä¸­...</h1>
                <p class="price" id="p-price" style="font-size:28px;"></p>

                <div class="suitability-box">
                    <p style="font-weight:bold; margin-bottom:10px;">ğŸ¾ è²“è²“é©é…åº¦å»ºè­°</p>
                    <div>å¹¼è²“ (0-12M) <span id="s-kitten" class="suit-stars"></span></div>
                    <div>æˆè²“ (1-7Y) <span id="s-adult" class="suit-stars"></span></div>
                    <div>ç†Ÿé½¡ (7Y+) <span id="s-senior" class="suit-stars"></span></div>
                </div>

                <p id="p-desc" style="color:#666; margin-bottom:20px;"></p>

                <div class="flavor-btns" id="option-area" style="display:none;">
                    <p id="option-title" style="margin-bottom:10px; font-weight:bold;"></p>
                    <div id="option-buttons"></div>
                </div>

                <div style="margin:20px 0;">
                    æ•¸é‡ï¼š
                    <input type="number" id="p-qty" value="1" min="1" style="width:50px; padding:5px;">
                </div>

                <button class="btn-add" onclick="addToCart()">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>

        <div class="review-section">
            <h3 style="color:#ff9f43; margin-bottom:15px;">ç”¢å“æˆåˆ†</h3>
            <div
                id="p-full-detail"
                style="background:#f9f9f9; padding:20px; border-radius:10px; line-height:1.8; color:#555;">
            </div>
    </div>
    
    <div class="review-section" onclick="event.stopPropagation()">
    <h3 style="margin-bottom:15px;">ğŸ± ç•™ä¸‹å¦³çš„å•†å“è©•åƒ¹</h3>

    <div class="star-rating">
    <span class="star" data-value="1">â˜…</span>
    <span class="star" data-value="2">â˜…</span>
    <span class="star" data-value="3">â˜…</span>
    <span class="star" data-value="4">â˜…</span>
    <span class="star" data-value="5">â˜…</span>
    </div>

    <input
    id="review-name"
    class="review-name"
    placeholder="æš±ç¨±ï¼ˆå¯ç•™ç©ºï¼‰"
    />

    <textarea
        id="review-text"
        placeholder="å¯«ä¸‹å¦³çš„å¿ƒå¾—â€¦"
        class="review-text"
    ></textarea>

    <button id="submit-review">é€å‡ºè©•åƒ¹</button>

    <p
    style="
        margin-top:10px;
        font-size:13.5px;
        color:#a66a2f;
        line-height:1.6;
        background:#fff6eb;
        padding:8px 12px;
        border-radius:12px;
        display:inline-block;
    "
    >
    ğŸ± å°æé†’ï¼šè©•åƒ¹ä¸èƒ½åˆªæ‰å–”ï½<br>
    ä½†é‡æ–°é€å‡ºå¯ä»¥å¹«å®ƒæ›æ–°è¡£âœ¨
    </p>
    <div id="review-summary" style="margin-top:30px;"></div>


    <h4 class="review-title">ğŸ’¬ å…¶ä»–è²“å¥´æ€éº¼èªª</h4>
    <div id="review-list"></div>
    </div>

        <script src="../js/product.js"></script>
        <script src="../js/cart.js"></script>

        <script>
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));

    if (currentUser && currentUser.username) {
        const nameInput = document.getElementById('review-name');
        if (nameInput) {
            nameInput.value = currentUser.username;
            nameInput.disabled = true; 
            nameInput.style.background = "#f7f7f7";
        }
    }


    /* åŸºæœ¬è³‡æ–™*/
    const products = window.products;;
    const productId = new URLSearchParams(window.location.search).get('id');
    let selectedRating = 0;
    let selectedFlavor = "";
    let selectedPack = "";
    let currentVariant = null;
    let p = null;
    let reviewerKey = localStorage.getItem("reviewerKey");
    if (!reviewerKey) {
        reviewerKey = crypto.randomUUID();
        localStorage.setItem("reviewerKey", reviewerKey);
    }
    /* ========= è¼‰å…¥å•†å“ ========= */
    if (productId && products && products[productId]) {
        p = products[productId];

        document.getElementById('p-name').innerText = p.name;
        document.getElementById('p-desc').innerHTML = p.desc || "";
        document.getElementById('p-img').src = p.img;
        document.getElementById('p-full-detail').innerHTML =
            p.fullDetail || "æš«ç„¡è©³ç´°æˆåˆ†è³‡è¨Š";

        renderSuitability(p);
        renderOptions(p);
        renderReviews();
    } else {
        alert("æ‰¾ä¸åˆ°å•†å“è³‡æ–™");
    }

    /* è¦æ ¼é¸æ“‡*/
    function renderOptions(p) {
        if (!p.variants || !Array.isArray(p.variants)) {
            document.getElementById('p-price').innerText =
                "$" + (p.price || p.defaultPrice || 0);
            return;
        }



        const hasFlavor = p.variants[0].flavor !== undefined;
        const hasPack = p.variants[0].pack !== undefined;
        const hasWeight = p.variants[0].weight !== undefined;

        document.getElementById('option-area').style.display = 'block';
        document.getElementById('option-buttons').innerHTML = '';
        renderReviews();

        /* å£å‘³ + åŒ…è£ */
        if (hasFlavor && hasPack) {
            document.getElementById('option-title').innerText = "é¸æ“‡è¦æ ¼";

            const flavorArea = document.createElement('div');
            flavorArea.id = "flavor-buttons";
            document.getElementById('option-buttons').appendChild(flavorArea);

            const flavors = [...new Set(p.variants.map(v => v.flavor))];
            selectedFlavor = flavors[0];

            flavors.forEach((flavor, idx) => {
                const btn = document.createElement('button');
                btn.className = "flavor-btn" + (idx === 0 ? " active" : "");
                btn.innerText = flavor;
                btn.onclick = () => {
                    document.querySelectorAll('#flavor-buttons .flavor-btn')
                        .forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedFlavor = flavor;
                    renderPackButtons();
                };
                flavorArea.appendChild(btn);
            });

            function renderPackButtons() {
                let packArea = document.getElementById('pack-buttons');
                if (!packArea) {
                    packArea = document.createElement('div');
                    packArea.id = 'pack-buttons';
                    document.getElementById('option-buttons').appendChild(packArea);
                }
                packArea.innerHTML = '';

                const filtered = p.variants.filter(v => v.flavor === selectedFlavor);
                currentVariant = filtered[0];

                filtered.forEach((variant, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "flavor-btn" + (idx === 0 ? " active" : "");
                    btn.innerText = variant.pack;
                    btn.onclick = () => {
                        packArea.querySelectorAll('.flavor-btn')
                            .forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentVariant = variant;
                        document.getElementById('p-price').innerText = "$" + variant.price;
                    };
                    packArea.appendChild(btn);
                });

                document.getElementById('p-price').innerText =
                    "$" + currentVariant.price;
            }

            renderPackButtons();
        }

        /* é‡é‡å‹ */
        else if (hasWeight) {
            document.getElementById('option-title').innerText = "é¸æ“‡è¦æ ¼";
            p.variants.forEach((variant, idx) => {
                const btn = document.createElement('button');
                btn.className = "flavor-btn" + (idx === 0 ? " active" : "");
                btn.innerText = variant.weight;
                btn.onclick = () => {
                    document.querySelectorAll('.flavor-btn')
                        .forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentVariant = variant;
                    document.getElementById('p-price').innerText = "$" + variant.price;
                };
                document.getElementById('option-buttons').appendChild(btn);
            });

            currentVariant = p.variants[0];
            document.getElementById('p-price').innerText =
                "$" + currentVariant.price;
        }
    }

    /* é©é…åº¦*/
    function renderSuitability(p) {
        const stars = n => "â˜…".repeat(n) + "â˜†".repeat(5 - n);
        document.getElementById('s-kitten').innerText = stars(p.suitKitten || 0);
        document.getElementById('s-adult').innerText = stars(p.suitAdult || 0);
        document.getElementById('s-senior').innerText = stars(p.suitSenior || 0);
    }

    /*  åŠ å…¥è³¼ç‰©è»Š*/
    function addToCart() {
        if (!p) return;

        const qty = parseInt(document.getElementById('p-qty').value);
        const variant = currentVariant || p;

        let name = p.name;
        if (variant.flavor) name += ` - ${variant.flavor}`;
        if (variant.pack) name += ` - ${variant.pack}`;
        if (variant.weight) name += ` - ${variant.weight}`;

        const price = variant.price || p.price || p.defaultPrice;

        localStorage.setItem("lastProductId", productId);

        const cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.push({
            id: productId,
            name,
            price,
            img: p.img,
            qty
        });

        localStorage.setItem('myCart', JSON.stringify(cart));
        alert("å·²åŠ å…¥è³¼ç‰©è»Š ğŸ¾");
    }


    /* è©•åƒ¹é¡¯ç¤º */
    function renderReviews() {
        const reviewList = document.getElementById('review-list');
        const summary = document.getElementById('review-summary');
        if (!reviewList || !summary) return;

        const reviews = JSON.parse(localStorage.getItem("reviews")) || [];
        const list = reviews.filter(r => r.productId === productId);

        if (list.length === 0) {
            summary.innerHTML = "";
            reviewList.innerHTML = "<p style='color:#999;'>å°šç„¡è©•åƒ¹</p>";
            return;
        }

        const avg = list.reduce((sum, r) => sum + r.rating, 0) / list.length;

        summary.innerHTML = `
            <strong>${avg.toFixed(1)}</strong>
            <span style="color:#ff9f43;">
                ${"â˜…".repeat(Math.round(avg))}
            </span>
            <span style="color:#999;">
                ï¼ˆ${list.length} å‰‡è©•åƒ¹ï¼‰
            </span>
        `;

        reviewList.innerHTML = list
            .map(r => `
                <div class="review-item" style="border-bottom:1px solid #eee;padding:12px 0;">
                    <strong>ğŸ¾ ${r.username || "åŒ¿åè²“å¥´"}</strong>
                    <div style="color:#ff9f43;">
                        ${"â˜…".repeat(r.rating)}${"â˜†".repeat(5 - r.rating)}
                    </div>
                    <p>${r.text}</p>
                    <small style="color:#aaa;">${r.time}</small>
                </div>
            `)
            .join("");
    }

    /* åˆå§‹åŒ– */
    document.addEventListener("DOMContentLoaded", () => {

        /* â­ æ˜Ÿæ˜Ÿé»æ“Š */
        document.addEventListener(
            "click",
            (e) => {
                const star = e.target.closest(".star");
                if (!star) return;

                e.stopPropagation();
                selectedRating = Number(star.dataset.value);

                document.querySelectorAll(".star").forEach(s => {
                    s.classList.toggle(
                        "active",
                        Number(s.dataset.value) <= selectedRating
                    );
                });
            },
            true
        );

        /* é€å‡ºè©•è«– */
        document.getElementById("submit-review")
            ?.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();

                const text = document.getElementById("review-text").value.trim();
                const nameInput = document.getElementById("review-name")?.value.trim();

                const currentUser = JSON.parse(localStorage.getItem("currentUser"));
                const username =
                    nameInput ||
                    (currentUser && currentUser.username) ||
                    "åŒ¿åè²“å¥´";

                if (selectedRating === 0) return alert("è«‹é¸æ“‡æ˜Ÿç­‰");
                if (!text) return alert("è«‹è¼¸å…¥è©•è«–å…§å®¹");

                let reviewerKey = localStorage.getItem("reviewerKey");
                if (!reviewerKey) {
                    reviewerKey = crypto.randomUUID();
                    localStorage.setItem("reviewerKey", reviewerKey);
                }

                const reviews = JSON.parse(localStorage.getItem("reviews")) || [];

                const existingIndex = reviews.findIndex(r =>
                    r.productId === productId &&
                    r.reviewerKey === reviewerKey
                );

                if (existingIndex !== -1) {
                    reviews[existingIndex] = {
                        ...reviews[existingIndex],
                        rating: selectedRating,
                        text,
                        username,
                        time: new Date().toLocaleString()
                    };
                } else {
                    reviews.push({
                        productId,
                        reviewerKey,
                        username,
                        rating: selectedRating,
                        text,
                        time: new Date().toLocaleString()
                    });
                }

                localStorage.setItem("reviews", JSON.stringify(reviews));

                document.getElementById("review-text").value = "";
                selectedRating = 0;
                document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));

                renderReviews();
            });
    });
    </script>
    <aside class="cart-sidebar" id="cartSidebar" role="dialog" aria-modal="true" aria-labelledby="cartTitle" tabindex="-1" hidden>
        <div class="cart-header">
            <h3 id="cartTitle">è³¼ç‰©è¢‹</h3>
            <button id="close-btn" type="button" class="icon-btn" aria-label="é—œé–‰è³¼ç‰©è»Š">&times;</button>
        </div>

        <div id="cart-items-list" class="cart-items" aria-live="polite"></div>

        <div class="cart-footer">
            <div class="cart-total-row">
                <span>ç¸½è¨ˆ</span>
                <span id="cart-total-display">$0</span>
            </div>
            <button class="checkout-btn" type="button" onclick="location.href='checkout.html'">
                å‰å¾€çµå¸³
            </button>
        </div>
    </aside>
    <script src="../js/chat.js"></script>
</body>
</html>